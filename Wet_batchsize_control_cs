
using System;
using System.Collections;
using System.Data;
using System.Data.OleDb;
using System.Text;
using System.Web;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Configuration;
using P12RTD_DLL;
using LoginCheckServiceProvider;
using System.Runtime.Remoting.Messaging;
using System.Net.Cache;
using System.Diagnostics.Eventing.Reader;
using System.Runtime.Remoting.Contexts;
using System.Collections.Specialized;
using System.Linq;

public partial class WetBatchSizeControl : System.Web.UI.Page
{
    string vCheckResult;
    string vFunctionName = "WET_BATCH_SIZE_CONTROL";
    string vTableName = "RTD.WET_BATCH_SIZE_CONTROL";
    string ConnectionString = ConfigurationSettings.AppSettings["RTD_P12"];
    Access_control RTD_ACCESS_CONTROL = new Access_control();
    Table_Info_control RTD_TABLE_INFO = new Table_Info_control();

    // 篩選條件集合
    private ArrayList FilterConditions
    {
        get
        {
            if (Session["FilterConditions"] == null)
                Session["FilterConditions"] = new ArrayList();
            return (ArrayList)Session["FilterConditions"];
        }
        set
        {
            Session["FilterConditions"] = value;
        }
    }

    protected void Page_Load(object sender, EventArgs e)
    {

        // 每次載入都執行記住密碼功能
        LoadUserCredentials();

        // 每次都註冊JS，避免事件遺失
        RegisterClientScript();

        // 更新篩選條件顯示
        UpdateFilterDisplay();

        if (IsPostBack)
        {

            string target = Request["__EVENTTARGET"] ?? "";
            string arg = Request["__EVENTARGUMENT"] ?? "";

            if (target == "DeleteRecord")
            {
                System.Diagnostics.Debug.WriteLine("PostBack => DeleteRecord, arg=" + arg);
                Page.ClientScript.RegisterStartupScript(this.GetType(), "debugDeleteRecord", string.Format("console.log('後端已執行 DeleteRecord，ID1={0}');", arg), true);
                DeleteRecord(arg);
                //InitializePage();
                return;
            }
            else if (target == "UpdateActive")
            {
                System.Diagnostics.Debug.WriteLine("PostBack => UpdateActive, arg=" + arg);
                Page.ClientScript.RegisterStartupScript(this.GetType(), "debugUpdateActive", string.Format("console.log('後端已執行 UpdateActiveStatus，ID1={0}');", arg), true);
                UpdateActiveStatus(arg);
                //InitializePage();
                return;
            }
            else if (target == "AddFilter")
            {
                System.Diagnostics.Debug.WriteLine("PostBack => AddFilter, arg=" + arg);
                Page.ClientScript.RegisterStartupScript(this.GetType(), "debugAddFilter", string.Format("console.log('後端已執行 AddFilterCondition，arg={0}');", arg), true);
                AddFilterCondition(arg);
                //InitializePage();
                return;
            }
            else if (target == "SaveRecord")
            {
                string[] parts = arg.Split('|');
                if (parts.Length >= 4) {
                    string id = parts[0];
                    int batchSize = int.Parse(parts[1]);
                    int? minWafer = string.IsNullOrEmpty(parts[2]) ? (int?)null : int.Parse(parts[2]);
                    string memo = parts[3];
                    UpdateRecord(id, batchSize, minWafer, memo);
                    //InitializePage();
                    LoadData();
                }
                return;
            }
        }

        if (!IsPostBack)
        {
            if (Session["Message"] != null)
            {
                ShowMessage(Session["Message"].ToString(), Session["MessageCss"].ToString());
                Session.Remove("Message");
                Session.Remove("MessageCss");
            }
            InitializePage();
            LoadData();
        }

    }

    private void InitializePage()
    {
        UpdateLastUpdateTime();
    }

    private void UpdateLastUpdateTime()
    {
        DataSet ds_temp = new DataSet();
        ds_temp = RTD_TABLE_INFO.Find_Data(vFunctionName);
        string lastUpdateTime = ds_temp.Tables[vFunctionName].Rows[0]["Last_Update_time"].ToString();

        string timeScript = @"
            if (document.getElementById('lastUpdateTime')) {
                document.getElementById('lastUpdateTime').innerHTML = '" + lastUpdateTime + @"';
            }";
        ClientScript.RegisterStartupScript(this.GetType(), "updateTime", timeScript, true);
    }

    private void LoadUserCredentials()
    {
        if (Session["RememberUser"] != null && (bool)Session["RememberUser"])
        {
            if (Session["UserID"] != null)
                userID.Value = Session["UserID"].ToString();
            if (Session["Password"] != null)
                passward.Value = Session["Password"].ToString();
            rememberMe.Checked = true;
        }
    }

    private void RegisterClientScript()
    {
        // 只註冊一次 jQuery
        if (!Page.ClientScript.IsClientScriptIncludeRegistered("jquery"))
        {
            Page.ClientScript.RegisterClientScriptInclude(
                "jquery",
                ResolveUrl("~/script/jquery-3.7.0.min.js")
            );
        }

        // 註冊全域函數供 ASP.NET PostBack 使用
        string globalScript = @"
            window.deleteRecord = function(id) {
                if (typeof __doPostBack === 'function') {
                    __doPostBack('DeleteRecord', id);
                } else {
                    console.warn('__doPostBack not available');
                }
            };
            
            window.updateActive = function(id, isChecked) {
                if (confirm('確定要變更此設定的啟用狀態嗎?')) {
                    var arg = id + '|' + (isChecked ? 'true' : 'false');
                    if (typeof __doPostBack === 'function') {
                        __doPostBack('UpdateActive', arg);
                    }
                    else {
                        console.warn('__doPostBack not available');
                    }
                }
                else {
                    // 用戶取消，還原為原始狀態
                    event.target.checked = !isChecked;
                }
            };
        ";

        Page.ClientScript.RegisterStartupScript(
            this.GetType(),
            "GlobalFunctions",
            globalScript,
            true
        );
    }

    protected void btnAdd_SeverClick(object sender, EventArgs e)
    {
        try
        {
            if (!ValidateForm())
                return;

            if (!checkMM())
            {
                ShowMessage("使用者驗證失敗", "alert-danger");
                return;
            }

            SaveUserCredentials();

            if (InsertBatchSizeSetting())
            {
                Session["Message"] = "新增設定成功";
                Session["MessageCss"] = "alert-success";
                Response.Redirect(Request.RawUrl);
                Context.ApplicationInstance.CompleteRequest();
            }
            else
            {
                ShowMessage("新增設定失敗", "alert-danger");
            }
        }
        catch (Exception ex)
        {
            ShowMessage("系統錯誤: " + ex.Message, "alert-danger");
        }
    }

    protected void btnExecuteFilter_ServerClick(object sender, EventArgs e)
    {
        try
        {
            LoadData();
            ShowMessage("篩選執行完成，共 " + FilterConditions.Count + " 個條件", "alert-info");
        }
        catch (Exception ex)
        {
            ShowMessage("篩選執行失敗: " + ex.Message, "alert-danger");
        }
    }

    protected void btnClearFilter_ServerClick(object sender, EventArgs e)
    {
        try
        {
            FilterConditions.Clear();
            filterConditions.Value = "";
            LoadData();
            ShowMessage("篩選條件已清除", "alert-info");
        }
        catch (Exception ex)
        {
            ShowMessage("清除篩選條件失敗: " + ex.Message, "alert-danger");
        }
    }

    private void AddFilterCondition(string conditionData)
    {
        // 驗證輸入值
        if (string.IsNullOrEmpty(conditionData))
        {
            ShowMessage("篩選條件資料為空!", "alert-warning");
            return;
        }

        try
        {
            string[] parts = conditionData.Split('|');
            if (parts.Length >= 4)
            {
                // 驗證條件值不為空
                string value = parts[2] != null ? parts[2].Trim().ToUpper() : "";

                if (string.IsNullOrEmpty(value))
                {
                    ShowMessage("請輸入篩選條件值!", "alert-warning");
                    return;
                }

                FilterCondition condition = new FilterCondition(parts[0], parts[1], value, parts[3]);
                FilterConditions.Add(condition);
                UpdateFilterDisplay();

                // 重新載入資料
                LoadData();

                ClientScript.RegisterStartupScript(this.GetType(), "clearFilter",
                    "if (document.getElementById('filterValue')) { document.getElementById('filterValue').value = ''; }", true);

                ShowMessage("篩選條件已新增: " + parts[0] + " " + GetOperatorText(parts[1] , value), "alert-success");
            }

            else
            {
                ShowMessage("篩選條件格式不正確!", "alert-danger");
            }
        }
        catch (Exception ex)
        {
            ShowMessage("新增篩選條件失敗: " + ex.Message, "alert-danger");
        }
    }

    private void UpdateActiveStatus(string data)
    {
        try
        {
            if (!checkMM())
            {
                ShowMessage("使用者驗證失敗", "alert-danger");
                return;
            }

            string[] parts = data.Split('|');
            if (parts.Length < 2)
            {
                ShowMessage("更新狀態失敗：參數不足", "alert-danger");
                return;
            }

            string id = parts[0];
            string updUser = Request.ServerVariables.Get("AUTH_USER");
            bool isActive = parts[1].Equals("true", System.StringComparison.OrdinalIgnoreCase);

            using (OleDbConnection conn = new OleDbConnection(ConnectionString))
            {
                string query = "UPDATE " + vTableName;
                query += " SET ACTIVE = ?, UPDATE_USER = ?, UPDATE_TIME = SYSDATE WHERE ID1 = ?";
                using (OleDbCommand cmd = new OleDbCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("ACTIVE", isActive ? 1 : 0);
                    cmd.Parameters.AddWithValue("UPDATE_USER", updUser);
                    cmd.Parameters.AddWithValue("ID1", id);

                    conn.Open();
                    int result = cmd.ExecuteNonQuery();
                    if (result > 0)
                    {
                        UpdateLog(id, "UPDATE");
                        RTD_TABLE_INFO.Update_LastUpdateTime(vFunctionName, updUser);
                        UpdateLastUpdateTime();
                        ShowMessage("設定狀態已更新為: " + (isActive ? "啟用" : "停用"), "alert-success");
                        LoadData();
                    }
                    else
                    {
                        ShowMessage("更新失敗，找不到指定的記錄", "alert-warning");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ShowMessage("更新狀態失敗: " + ex.Message, "alert-danger");
        }
    }

    private void DeleteRecord(string idString)
    {
        try
        {
            if (!checkMM())
            {
                ShowMessage("使用者驗證失敗", "alert-danger");
                return;
            }

            using (OleDbConnection conn = new OleDbConnection(ConnectionString))
            {
                string query = "DELETE " + vTableName;
                query += " WHERE ID1 = ?";

                // debug
                //System.Diagnostics.Debug.WriteLine("===DeleteRecord() called ===");
                //System.Diagnostics.Debug.WriteLine("SQL:"+query);
                //System.Diagnostics.Debug.WriteLine("Parameters: ID1=" + idString);

                using (OleDbCommand cmd = new OleDbCommand(query, conn))
                {
                    string updUser = Request.ServerVariables.Get("AUTH_USER");
                    cmd.Parameters.AddWithValue("ID1", idString);

                    conn.Open();
                    UpdateLog(idString, "DELETE");
                    int result = cmd.ExecuteNonQuery();
                    if (result > 0)
                    {
                        RTD_TABLE_INFO.Update_LastUpdateTime(vFunctionName, updUser);
                        UpdateLastUpdateTime();
                        ShowMessage("記錄已成功刪除", "alert-success");
                        LoadData();
                    }
                    else
                    {
                        ShowMessage("刪除失敗，找不到指定的記錄", "alert-warning");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ShowMessage("刪除記錄失敗: " + ex.Message, "alert-danger");
        }
    }

    private void UpdateRecord(string idString, int batchSize, int? minWafer, string memo)
    {
        if (!checkMM())
        {
            ShowMessage("使用者驗證失敗", "alert-danger");
            return;
        }

        ArrayList errors = new ArrayList();

        if (batchSize == 1)
        {
            if (!minWafer.HasValue || minWafer.Value < 1 || minWafer.Value > 25)
            {
                errors.Add("單批設定，min wafer count需介於1到25片");
            }
        }

        else if (batchSize == 2)
        {
            if (!minWafer.HasValue || minWafer.Value < 2 || minWafer.Value > 50)
            {
                errors.Add("雙批設定，min wafer count需介於2到50片");
            }
        }

        if (errors.Count > 0)
        {
            ShowMessage("更新驗證錯誤:<br>" + string.Join("<br>", errors.ToArray()), "alert-danger");
        }
        
        
        try
        {
            using (OleDbConnection conn = new OleDbConnection(ConnectionString))
            {
                //string query = "UPDATE RTD.WET_BATCH_SIZE_CONTROL SET BATCH_SIZE = ?, MIN_WAFER_COUNT = ?, MEMO = ?, UPDATE_USER = ?, UPDATE_TIME = SYSDATE WHERE ID1 = ?";
                string query = "UPDATE " + vTableName;
                query += " SET BATCH_SIZE = ?, MIN_WAFER_COUNT = ?, MEMO = ?, UPDATE_USER = ?, UPDATE_TIME = SYSDATE WHERE ID1 = ?";

                using (OleDbCommand cmd = new OleDbCommand(query, conn))
                {
                    string updUser = Request.ServerVariables.Get("AUTH_USER");
                    cmd.Parameters.AddWithValue("BatchSize", batchSize);
                    cmd.Parameters.AddWithValue("MinWaferCount", (object) minWafer ?? DBNull.Value);
                    cmd.Parameters.AddWithValue("Memo", memo ?? "");
                    cmd.Parameters.AddWithValue("UPDATE_USER", updUser);
                    cmd.Parameters.AddWithValue("ID1", idString);

                    conn.Open();
                    int result = cmd.ExecuteNonQuery();
                    if (result > 0)
                    {
                        UpdateLog(idString, "UPDATE");
                        RTD_TABLE_INFO.Update_LastUpdateTime(vFunctionName, updUser);
                        UpdateLastUpdateTime();
                        ShowMessage("記錄已成功更新", "alert-success");
                        LoadData();
                    }
                    else
                    {
                        ShowMessage("更新失敗，找不到指定的記錄", "alert-warning");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ShowMessage("更新記錄失敗: " + ex.Message, "alert-danger");
        }
    }

    private void UpdateLog(string id, string actionType) {
        string query = @"
            INSERT INTO RTD.WET_BATCH_SIZE_CONTROL_LOG
            (EQP_ID, PRODG_ID, PRODUCT_GROUP, PRODSPEC_ID, OPE_NO, 
            BATCH_SIZE, MIN_WAFER_COUNT, MEMO, UPDATE_USER, UPDATE_TIME, ACTIVE, ID1, ACTION_TYPE) 
            SELECT EQP_ID, PRODG_ID, PRODUCT_GROUP, PRODSPEC_ID, OPE_NO,
            BATCH_SIZE, MIN_WAFER_COUNT, MEMO, UPDATE_USER, SYSDATE, ACTIVE, ID1, ? 
            FROM RTD.WET_BATCH_SIZE_CONTROL WHERE ID1 = ? ";

        try
        {
            using (OleDbConnection conn = new OleDbConnection(ConnectionString))
            {
                using (OleDbCommand cmd = new OleDbCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("ACTION", actionType);
                    cmd.Parameters.AddWithValue("ID1", id);
                    conn.Open();
                    cmd.ExecuteNonQuery();
                }
            }
        }
        catch (Exception ex) {
            ShowMessage("新增Log失敗: " + ex.Message, "alert-danger");
        }
    }

    private void UpdateFilterDisplay()
    {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < FilterConditions.Count; i++)
        {
            FilterCondition condition = (FilterCondition)FilterConditions[i];
            if (i > 0)
                sb.Append(" " + condition.Logic + " ");

            string operatorText = GetOperatorText(condition.Operator, condition.Value);
            sb.Append(condition.Field + " " + operatorText);
        }
        filterConditions.Value = sb.ToString();
    }

    private string GetOperatorText(string op, string val)
    {
        switch (op)
        {
            case "=": return "=" + " '" + val + "'";
            case "!=": return "!=" + " '" + val + "'";
            case ">": return ">" + " '" + val + "'";
            case ">=": return ">=" + " '" + val + "'";
            case "<": return "<" + " '" + val + "'";
            case "<=": return "<=" + " '" + val + "'";
            case "like_start": return "LIKE" + " '" + val + "%'";
            case "like_end": return "LIKE" + " '%" + val + "'";
            case "not_like_start": return "NOT LIKE" + " '" + val + "%'";
            case "not_like_end": return "NOT LIKE" + " '%" + val + "'";
            case "like": return "LIKE" + " '%" + val + "%'";
            case "not_like": return "NOT LIKE" + " '%" + val + "%'";
            default: return "=" + " '" + val + "'";
        }
    }

    private bool ValidateUser()
    {
        string userId = userID.Value != null ? userID.Value.Trim() : "";
        string password = passward.Value != null ? passward.Value.Trim() : "";

        if (string.IsNullOrEmpty(userId) || string.IsNullOrEmpty(password))
            return false;

        try
        {
            vCheckResult = RTD_ACCESS_CONTROL.Check_Authority(vFunctionName, userId, password);
            if (vCheckResult == "Authentication Fail")
            {
                this.Session.Remove("Password");
                return false;
            }
            else
            {
                return true;
            }
        }
        catch (Exception ex)
        {
            ShowMessage("登入失敗: " + ex.Message, "alert-danger");
            return false;
        }
    }

    private bool checkMM()
    {
        cCredentialSoapHeader credential = new cCredentialSoapHeader();
        LoginCheckService logincheck = new LoginCheckService();
        credential.Username = "WS_RTD";
        credential.Password = "py20@RTD+dIKa/wZK+aihwAk15sJQJQ==";

        string userId = userID.Value != null ? userID.Value.Trim() : "";
        string password = passward.Value != null ? passward.Value.Trim() : "";

        logincheck.cCredentialSoapHeaderValue = credential;

        if (string.IsNullOrEmpty(userId) || string.IsNullOrEmpty(password))
            return false;

        try {
            string result = logincheck.VerifyWithMessage(userId, password);

            if (result.Substring(0, 4) == "0|+|")
            {
                return true;
            }

            else {
                this.Session.Remove("Password");
                return false;
            }
        }
        catch (Exception ex)
        {
            ShowMessage("登入失敗: " + ex.Message, "alert-danger");
            return false;
        }
    }

    private bool ValidateForm()
    {
        ArrayList errors = new ArrayList();

        if (string.IsNullOrEmpty(txb_eqpid.Value))
            errors.Add("EQP_ID 不能為空");
        else if (txb_eqpid.Value == "*")
            errors.Add("EQP_ID 不能為*");
        if (string.IsNullOrEmpty(txb_prodgid.Value))
            errors.Add("PRODG_ID 不能為空");
        if (string.IsNullOrEmpty(tbx_prodgrp.Value))
            errors.Add("PRODUCT_GROUP 不能為空");
        if (string.IsNullOrEmpty(tbx_prodspecid.Value))
            errors.Add("PRODSPEC_ID 不能為空");
        if (string.IsNullOrEmpty(tbx_openo.Value))
            errors.Add("OPE_NO 不能為空");
        if (string.IsNullOrEmpty(batch_size.Value))
            errors.Add("BATCH_SIZE 必須選擇");

        if (!string.IsNullOrEmpty(tbx_min_wafer_cnt.Value))
        {
            int waferCount;
            if (!int.TryParse(tbx_min_wafer_cnt.Value, out waferCount) || waferCount < 0)
                errors.Add("MIN_WAFER_COUNT 必須是非負整數");
            else {
                if (batch_size.Value == "1" && (waferCount < 1 || waferCount > 25))
                    errors.Add("單批設定，min wafer count需介於1到25片");
                else if (batch_size.Value == "2" && (waferCount < 2 || waferCount > 50))
                    errors.Add("雙批設定，min wafer count需介於2到50片");
            }
        }

        if (errors.Count > 0)
        {
            ShowMessage("表單驗證錯誤:<br>" + string.Join("<br>", errors.ToArray()), "alert-danger");
            return false;
        }

        return true;
    }

    private void SaveUserCredentials()
    {
        if (rememberMe.Checked)
        {
            Session["RememberUser"] = true;
            Session["UserID"] = userID.Value;
            Session["Password"] = passward.Value;
            //Session.Timeout = 480; // 8小時
        }
        else
        {
            Session.Remove("RememberUser");
            Session.Remove("UserID");
            Session.Remove("Password");
        }
    }

    private bool InsertBatchSizeSetting()
    {
        try
        {
            using (OleDbConnection conn = new OleDbConnection(ConnectionString))
            {
                string newID = GenerateRandomId();
                string updUser = Request.ServerVariables.Get("AUTH_USER");
                //string query = @"
                //    INSERT INTO RTD.WET_BATCH_SIZE_CONTROL 
                //    (EQP_ID, PRODG_ID, PRODUCT_GROUP, PRODSPEC_ID, OPE_NO, BATCH_SIZE, MIN_WAFER_COUNT, MEMO, UPDATE_USER, UPDATE_TIME, ACTIVE, ID1)
                //    VALUES 
                //    (?, ?, ?, ?, ?, ?, ?, ?, ?, SYSDATE, 1, ?)";

                string query = "INSERT INTO " + vTableName;
                query += " (EQP_ID, PRODG_ID, PRODUCT_GROUP, PRODSPEC_ID, OPE_NO, BATCH_SIZE, MIN_WAFER_COUNT, MEMO, UPDATE_USER, UPDATE_TIME, ACTIVE, ID1) ";
                query += " VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, SYSDATE, 1, ?)";

                using (OleDbCommand cmd = new OleDbCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@EqpId", txb_eqpid.Value.Trim().ToUpper());
                    cmd.Parameters.AddWithValue("@ProdgId", txb_prodgid.Value.Trim().ToUpper());
                    cmd.Parameters.AddWithValue("@ProductGroup", tbx_prodgrp.Value.Trim().ToUpper());
                    cmd.Parameters.AddWithValue("@ProdspecId", tbx_prodspecid.Value.Trim().ToUpper());
                    cmd.Parameters.AddWithValue("@OpeNo", tbx_openo.Value.Trim().ToUpper());

                    int batchSizeValue;
                    int.TryParse(batch_size.Value, out batchSizeValue);
                    cmd.Parameters.AddWithValue("@BatchSize", batchSizeValue);

                    if (string.IsNullOrEmpty(tbx_min_wafer_cnt.Value))
                    {
                        cmd.Parameters.AddWithValue("@MinWaferCount", DBNull.Value);
                    }
                    else
                    {
                        int waferCount;
                        int.TryParse(tbx_min_wafer_cnt.Value, out waferCount);
                        cmd.Parameters.AddWithValue("@MinWaferCount", waferCount);
                    }

                    cmd.Parameters.AddWithValue("@Memo", tbx_memo.Value != null ? tbx_memo.Value.Trim() : "");
                    cmd.Parameters.AddWithValue("@UpdateUser", updUser);
                    cmd.Parameters.AddWithValue("@ID1", newID);

                    conn.Open();
                    int result = cmd.ExecuteNonQuery();
                    UpdateLog(newID, "INSERT"); //Log紀錄
                    RTD_TABLE_INFO.Update_LastUpdateTime(vFunctionName, updUser);
                    UpdateLastUpdateTime();
                    return result > 0;
                }
            }
        }
        catch (OleDbException ex)
        {
            if (ex.ErrorCode == -2147467259) // 主鍵或唯一約束違反
            {
                ShowMessage("資料已存在，請檢查是否重複新增!", "alert-warning");
                return false;
            }
            throw;
        }
    }

    private string GenerateRandomId(int length = 16) {
        const string chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        var random = new Random();
        return new string(Enumerable.Repeat(chars, length).Select(s => s[random.Next(s.Length)]).ToArray());
    }

    private void LoadData()
    {
        try
        {
            DataTable dt = GetBatchSizeData();

            GenerateDataTable(dt);

            DataSet ds_temp = new DataSet();
            ds_temp = RTD_TABLE_INFO.Find_Data(vFunctionName);
            string lastUploadTime = ds_temp.Tables[vFunctionName].Rows[0]["LAST_UPLOAD_2_RTD_TIME"].ToString();
            string timeScript = @"
                if (document.getElementById('lastUploadTime')) {
                    document.getElementById('lastUploadTime').innerHTML = '" + lastUploadTime + @"';
                }";
            ClientScript.RegisterStartupScript(this.GetType(), "updateUploadTime", timeScript, true);
        }
        catch (Exception ex)
        {
            ShowMessage("載入資料失敗: " + ex.Message, "alert-danger");
        }
    }

    private DataTable GetBatchSizeData()
    {
        using (OleDbConnection conn = new OleDbConnection(ConnectionString))
        {
            StringBuilder query = new StringBuilder(@"
                SELECT 
                    EQP_ID, PRODG_ID, PRODUCT_GROUP, PRODSPEC_ID, OPE_NO,
                    BATCH_SIZE, MIN_WAFER_COUNT, MEMO, UPDATE_USER, UPDATE_TIME, ACTIVE, ID1
                FROM RTD.WET_BATCH_SIZE_CONTROL");

            if (FilterConditions.Count > 0)
            {
                query.Append(" WHERE ");
                for (int i = 0; i < FilterConditions.Count; i++)
                {
                    FilterCondition condition = (FilterCondition)FilterConditions[i];
                    if (i > 0)
                        query.Append(" " + condition.Logic + " ");
                    //query.Append(BuildWhereClause(condition, i));
                    string operatorText = GetOperatorText(condition.Operator, condition.Value);
                    query.Append(condition.Field + " " + operatorText);
                }
            }

            query.Append(" ORDER BY UPDATE_TIME DESC");

            OleDbCommand cmd = new OleDbCommand(query.ToString(), conn);

            using (OleDbDataAdapter adapter = new OleDbDataAdapter(cmd))
            {
                DataTable dt = new DataTable();
                conn.Open();
                adapter.Fill(dt);
                return dt;
            }

        }
    }

    private void GenerateDataTable(DataTable dt)
    {
        StringBuilder html = new StringBuilder();
        html.Append("<table class='table-custom'>");
        html.Append("<thead><tr>");
        html.Append("<th style='width: 80px;'>修改</th>");
        html.Append("<th style='width: 80px;'>EQP_ID</th>");
        html.Append("<th style='width: 100px;'>PRODG_ID</th>");
        html.Append("<th style='width: 120px;'>PRODUCT_GROUP</th>");
        html.Append("<th style='width: 120px;'>PRODSPEC_ID</th>");
        html.Append("<th style='width: 80px;'>OPE_NO</th>");
        html.Append("<th style='width: 80px;'>BATCH_SIZE</th>");
        html.Append("<th style='width: 100px;'>MIN_WAFER_COUNT</th>");
        html.Append("<th style='width: 150px;'>MEMO</th>");
        html.Append("<th style='width: 80px;'>UPDATE_USER</th>");
        html.Append("<th style='width: 140px;'>UPDATE_TIME</th>");
        html.Append("<th style='width: 60px;'>啟用</th>");
        //html.Append("<th style='width: 80px;'>操作</th>");
        html.Append("</tr></thead>");
        html.Append("<tbody>");

        foreach (DataRow row in dt.Rows)
        {
            string id = row["ID1"].ToString();
            bool isActive = Convert.ToBoolean(row["ACTIVE"]);

            html.Append("<tr data-id='" + id + "'>");
            html.Append("<td class='modify-cell'>");
            html.Append("<button type='button' class='btn btn-custom btn-sm btn-edit' onclick=\"enterEditMode(this)\">修改</button>");
            html.Append("<button type='button' class='btn btn-success btn-sm btn-save' style='display:none' onclick=\"saveRow(this)\">儲存</button>");
            html.Append("<button type='button' class='btn btn-danger btn-sm btn-del' style='display:none' " + "onclick=\"deleteRecord('" + row["ID1"] + "')\">刪除</button>");
            html.Append("<button type='button' class='btn btn-custom btn-sm btn-cancel' style='display:none' onclick=\"cancelEdit(this)\">取消</button>");
            html.Append("</td>");

            html.Append("<td>" + row["EQP_ID"] + "</td>");
            html.Append("<td>" + row["PRODG_ID"] + "</td>");
            html.Append("<td>" + row["PRODUCT_GROUP"] + "</td>");
            html.Append("<td>" + row["PRODSPEC_ID"] + "</td>");
            html.Append("<td>" + row["OPE_NO"] + "</td>");
            html.Append("<td class='batch-size'>" + GetBatchSizeText(row["BATCH_SIZE"]) + "</td>");
            html.Append("<td class='min-wafer'>" + row["MIN_WAFER_COUNT"] + "</td>");
            html.Append("<td class='memo'>" + row["MEMO"] + "</td>");
            html.Append("<td>" + row["UPDATE_USER"] + "</td>");
            html.Append("<td>" + Convert.ToDateTime(row["UPDATE_TIME"]).ToString("yyyy-MM-dd HH:mm:ss") + "</td>");

            html.Append("<td class='modify-cell'>");
            html.Append("<input type='checkbox' " + (isActive ? "checked='checked'" : "") +
                       " onclick=\"updateActive('" + id + "', this.checked)\" />");
            html.Append("</td>");
           

            html.Append("</tr>");
        }

        html.Append("</tbody></table>");

        if (dt.Rows.Count == 0)
        {
            html.Clear();
            html.Append("<div class='alert alert-info' style='text-align: center;'>目前沒有符合條件的資料</div>");
        }

        tableContainer.InnerHtml = html.ToString();
    }

    private string GetBatchSizeText(object batchSize)
    {
        if (batchSize == null || batchSize == DBNull.Value)
            return "";

        switch (batchSize.ToString())
        {
            case "1": return "單批";
            case "2": return "雙批";
            default: return batchSize.ToString();
        }
    }

    private void ClearForm()
    {
        txb_eqpid.Value = "";
        txb_prodgid.Value = "";
        tbx_prodgrp.Value = "";
        tbx_prodspecid.Value = "";
        tbx_openo.Value = "";
        batch_size.Value = "";
        tbx_min_wafer_cnt.Value = "";
        tbx_memo.Value = "";
    }

    private void ShowMessage(string message, string cssClass)
    {
        pnlMessage.Visible = true;
        pnlMessage.CssClass = "alert " + cssClass;
        lblMessage.Text = message;

        string script = @"
            setTimeout(function() {
                var panel = document.getElementById('" + pnlMessage.ClientID + @"');
                if (panel) {
                    panel.style.display = 'none';
                }
            }, 3000);";
        ClientScript.RegisterStartupScript(this.GetType(), "hideMessage", script, true);
    }

    // 篩選條件類別
    public class FilterCondition
    {
        public string Field { get; set; }
        public string Operator { get; set; }
        public string Value { get; set; }
        public string Logic { get; set; }

        public FilterCondition()
        {
            Field = "";
            Operator = "";
            Value = "";
            Logic = "";
        }

        public FilterCondition(string field, string op, string value, string logic)
        {
            Field = field ?? "";
            Operator = op ?? "";
            Value = value ?? "";
            Logic = logic ?? "";
        }
    }
}
